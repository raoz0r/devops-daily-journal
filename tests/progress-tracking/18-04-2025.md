---
tags:
- docker
- docker-compose
- grafana
- prometheus
- loki
- promtail
- cadvisor
- node-exporter
- monitoring
- logging
- devops
- taglog
- newlog
- bash
---

# 18.04.2025

#docker #docker-compose #grafana #prometheus #loki #promtail #cadvisor #node-exporter #monitoring #logging #devops #taglog #newlog #bash <!-- markdownlint-disable MD018 -->
<!-- markdownlint-disable MD024 -->

## üåü Daily Goals

- [x] Create a Script ~/bin/newlog to create my daily log template
- [x] Create a script ~/bin/taglog to read my logs and append metadata tags at the beginning for obsidian
- [x] Incorporate it into a logging system /mnt/storage/logs/taglog.logs to be able to identify issues using Grafana and Loki
- [x] Made Promtail parse structured logs, filterable by event, file, level, and tags

---

## üìë Work Log

- Prometheus, Loki, and Promtail containers were not running
- Grafana and its services weren‚Äôt communicating after a project folder rename, due to network mismatches among containers
- Prometheus encountered DNS resolution errors, preventing it from scraping metrics from cadvisor and node-exporter.
- Automated tasks such as creating new tracking files and formatting them for readability in Obsidian.
- Implemented a logging system to track potential errors in Grafana.
- Promptail docker compose updated

---

## üë®üèΩ‚Äçüíª Troubleshooting

### üïµÔ∏èPromptail not ingesting taglog.log

Promtail wasn't ingesting taglog.log because the container couldn‚Äôt access the file. Even though the config was correct and Loki was up, the file was outside of Promtail‚Äôs volume mount, so it never started a tail routine. Once we mounted the host log directory into the container, Promtail detected and tailed the file as expected.

### üïµÔ∏èGrafana Network Issue After Folder Rename

Grafana and its services lost communication after a folder rename. This happened because Docker Compose generates network names based on the folder name, and renaming it caused containers to be placed in different networks. As a result, they could no longer resolve each other by name.

The containers were manually reattached to the appropriate shared network, which restored connectivity among services.

Refer to the Step-by-Step Reference section for technical commands.

---

### üïµÔ∏è Prometheus DNS Resolution Issue

Prometheus was unable to scrape metrics from cadvisor and node-exporter, throwing DNS-related errors such as: `dial tcp: lookup cadvisor on 127.0.0.11:53: server misbehaving`

This occurred because Prometheus, cadvisor, and node-exporter were running on different Docker networks, which broke internal DNS resolution between them. Docker service discovery only works within the same user-defined network, so resolving service names like `cadvisor:8080` failed.

The containers were reconnected to the correct network to re-establish internal communication. This restored the ability of Prometheus to scrape metrics from the expected targets.

For full technical steps, refer to the Step-by-Step Reference section.

---

### üïµÔ∏è Investigation & Diagnosis

After a reboot, the Prometheus, Loki, and Promtail containers were not running. Initial inspection showed that while the containers existed, their status was `Created`, which indicated they hadn't been properly initialized.

A check with Docker Compose confirmed that these services had not been fully created after the system reboot. This led to the suspicion of a misconfiguration or file system issue.

Upon investigation of the volumes, an old `grafana/` directory was discovered. Instead of holding actual configuration files, it contained folders named after the expected config files (e.g., `grafana/loki-config.yaml/`). This structure conflicted with Docker‚Äôs volume mount expectations, preventing the containers from launching properly.

The correct configuration files were already present in the intended `grafana-stack` directory, making the leftover `grafana/` folder redundant and harmful.

The broken directory was removed, and the containers were then started manually. All services resumed operation as expected.

For specific commands and procedural steps, refer to the Step-by-Step Reference section.

---

### üìì Bash Script to Automate Daily Log File Creation

This Bash script simplifies the process of creating a new Markdown (`.md`) file for daily logs. It generates a file named with the current date, pre-filled with a standard log structure, and logs the creation event for tracking purposes.

#### Purpose

The script is designed to streamline daily log creation by automating repetitive tasks such as file naming, template insertion, and logging. This is particularly useful for maintaining consistent documentation and tracking daily activities.

#### Key Features

##### 1. Automatic File Naming

- The script generates a file named with the current date in the format `DD.MM.YYYY.md` (e.g., `18.04.2025.md`).
- Ensures that each log file is uniquely named and easy to identify.

##### 2. Pre-Filled Template

- The script populates the new file with a standard Markdown template, including sections for goals, work logs, troubleshooting, references, and next-day previews.
- The placeholder `#replace-with-tags` is included for easy tag insertion.

##### 3. Logging

- Logs the creation of each new file to a specified log file (`/mnt/storage/logs/taglog.log`).
- Each log entry includes a timestamp, event type, and the name of the created file.

##### 4. Integration with CLI

- The script is designed to be run from the command line using a simple command (newlog).
- It is placed in the `~/bin` directory and made executable for easy access.

#### Workflow

##### 1. File Creation

- The script fetches the current date and uses it to name the new log file.
- A Markdown template is written to the file, ensuring a consistent structure.

##### 2. Logging the Event

- The script appends a log entry to the specified log file, recording the creation of the new log file.

##### 3. User Notification

- Outputs a message to the console confirming the creation of the log file and the addition of the log entry.

#### Example Use Case

This script is ideal for users who maintain daily logs, such as developers, project managers, or anyone using tools like Obsidian for personal knowledge management. By automating the creation of daily logs, it saves time and ensures consistency.

#### Notes

- Customization: The template can be modified to include additional sections or placeholders as needed.
- Dependencies: The script relies on standard Unix tools like `date` and `echo`.
- Path Configuration: Ensure that the `~/bin` directory is included in your system's `$PATH` for easy access to the newlog command.

The script can be found in the Step-by-Step section

---

### üìì Bash Script to add YAML front matter block at the top

This Bash script automates the process of tagging Markdown (`.md`) files in a specified directory (`TARGET_DIR`) based on inline tags found on the third line of each file. Here's a breakdown of its functionality:

#### Purpose

The script scans Markdown files modified in the last 24 hours (`-mtime -1`) within the target directory. It checks for existing YAML front matter with tags and, if absent, extracts inline tags from the third line of the file to inject them into a YAML front matter block at the top of the file.

#### Key Features

##### 1. Directory and File Selection

- The script looks for `.md` files in the `TARGET_DIR` that were modified in the last 24 hours.
- The list of files is stored in the `MODIFIED_FILES` variable.

##### 2. Command-Line Flags

- `--skip`: Focuses on files that already have tags or need manual review.
- `--success`: Focuses on files where tags are successfully injected.
- `--dry-run`: Simulates the script's actions without making any changes to the files.

##### 3. Tag Injection Logic

- If a file already has YAML front matter with tags, it logs a warning and skips the file.
- If no tags are found on the third line, it logs a warning and skips the file.
- If inline tags (e.g., `#tag1`, `#tag2`) are found, they are converted into a YAML-compatible format (e.g., `tags: tag1, tag2`) and injected into the file's YAML front matter.

##### 4. Logging

- Logs all actions (e.g., skipped files, injected tags) to a log file (`LOG_FILE`).
- Logs include timestamps, event types, and details about the processed files.

##### 5. Dry-Run Mode

- When `--dry-run` is enabled, the script outputs what it *would* do without modifying any files or logs.

#### Workflow

##### 1. File Iteration

- The script loops through each file in `MODIFIED_FILES`.

##### 2. YAML Front Matter Check

- If the file already has YAML front matter with tags, it skips further processing.

##### 3. Inline Tag Extraction

- Reads the third line of the file and extracts inline tags (e.g., `#tag1`, `#tag2`).

##### 4. Tag Injection

- If tags are found, it creates a temporary file with the new YAML front matter and appends the original file content.
- The temporary file replaces the original file unless `--dry-run` is enabled.

##### 5. Logging

- Logs the outcome of each file's processing to the console and the log file.

#### Example Use Case

I'm using Obsidian and in obsidian you can tag using # or the YAML way. Both of then have different purposes. Since I didn't want to double the work, I made a script to format it for me.

#### Notes

- Error Handling: The script exits with an error if an unknown flag is provided.
- Customization: You can adjust the `TARGET_DIR` and `LOG_FILE` paths to suit your environment.
- Dependencies: The script relies on standard Unix tools like `find`, `grep`, `sed`, and `mktemp`.

The script can be found in the Step-by-Step section

---

## üóÉÔ∏è Step-by-Step Reference

### üõ†Ô∏è Fix Docker Networking & Startup Issues for Grafana

#### 1. Check container status

```bash
docker ps -a | grep -E 'loki|promtail|prometheus'
```

#### 2. Check Docker Compose services

```bash
docker compose ps
```

#### 3. Inspect directories and clean up

```bash
sudo rm -rf /mnt/storage/docker/grafana
```

#### 4. Start containers manually

```bash
docker start prometheus loki promtail
```

#### 5. List Docker networks

```bash
docker network ls
```

#### 6. Inspect network membership for each container

```bash
docker inspect prometheus | grep -A 5 "Networks"
docker inspect cadvisor | grep -A 5 "Networks"
docker inspect node-exporter | grep -A 5 "Networks"
```

#### 7. Disconnect cadvisor from wrong network and connect it to the correct one

```bash
docker network disconnect grafana_default cadvisor
docker network connect grafana-stack_default cadvisor
```

#### 8. Repeat for node-exporter

```bash
docker network disconnect grafana_default node-exporter
docker network connect grafana-stack_default node-exporter
```

#### 9. (Optional) Verify from Prometheus using curl (from host)

```bash
docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' node-exporter
curl http://<ip>:9100/metrics
```

---

### ‚öôÔ∏è Add Bash Completion for Docker & Docker Compose

#### 1. Install bash-completion package

```bash
sudo apt-get install -y bash-completion
```

#### 2. Download Docker CLI completion script

```bash
sudo curl https://raw.githubusercontent.com/docker/docker-ce/master/components/cli/contrib/completion/bash/docker -o /etc/bash_completion.d/docker.sh
```

#### 3. Download Docker Compose completion script

```bash
sudo curl -L https://raw.githubusercontent.com/docker/compose/1.25.1/contrib/completion/bash/docker-compose -o /etc/bash_completion.d/docker-compose
```

---

### üìù Automate Daily Logs.md File Creation

#### 1. Create the script

```bash
mkdir -p ~/bin
vim ~/bin/newlog.sh
```

Paste this in `newlog.sh`:

```bash
#!/bin/bash
TODAY=$(date +"%d.%m.%Y")
FILENAME="$TODAY.md"
LOG_FILE="/mnt/storage/logs/taglog.log"

cat << EOF > "$FILENAME"
# $TODAY

#replace-with-tags <!-- markdownlint-disable-line MD018 -->

## üåü Daily Goals

- [ ] Task 1

## üõ†Ô∏è Work Log

## ‚ùó Troubleshooting

## ‚úÖ Step-by-Step Reference

## üîó Key Resources

## üóìÔ∏è Next Day Preview
EOF

echo "üìù Log created: $FILENAME"
echo "$(date +'%FT%T') level=info event=newlog file=$FILENAME" >> $LOG_FILE
echo "Log entry added to $LOG_FILE"
```

#### 2. Make it executable

```bash
chmod +x ~/bin/newlog.sh
```

#### 3. Rename to `newlog` for easy calling

```bash
mv ~/bin/newlog.sh ~/bin/newlog
```

#### 4. Add ~/bin to your PATH if not already

```bash
echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

#### 5. Run it from anywhere

```bash
newlog
```

### üìù Script to add correct metadata tags to daily files

#### Create the Script

```bash
#!/bin/bash

TARGET_DIR="/mnt/storage/GoogleDrive/02-areas/progress-tracking"
MODIFIED_FILES=$(find "$TARGET_DIR" -type f -name "*.md" -mtime -1)
LOG_FILE="/mnt/storage/logs/taglog.log"

FILTER="all"
DRY_RUN=false

# Parse CLI flags
while [[ $# -gt 0 ]]; do
    case "$1" in
        --skip)
            FILTER="skip"
            shift
            ;;
        --success)
            FILTER="success"
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        *)
            echo "‚ùå Unknown flag: $1"
            exit 1
            ;;
    esac
done

for FILE in $MODIFIED_FILES; do
    echo "üîç Checking $FILE"

    # Check if YAML already exists with tags
    if grep -q '^---' "$FILE"; then
        if grep -A 5 '^---' "$FILE" | grep -q '^tags:'; then
            if [ "$FILTER" = "all" ] || [ "$FILTER" = "skip" ]; then
                echo "‚è© $FILE Skipped already tagged."
            fi

            if [ "$DRY_RUN" = true ]; then
                echo "üß™ DRY RUN: Would log ‚Üí level=warn event=tag_skipped file=$(basename "$FILE") reason=already_tagged"
            else
                echo "$(date +'%FT%T') level=warn event=tag_skipped file=$(basename "$FILE") reason=already_tagged" >> "$LOG_FILE"
            fi

            continue
        fi
    fi


    # Get line 3 and extract inline #tags
    TAG_LINE=$(sed -n '3p' "$FILE")
    INLINE_TAGS=$(echo "$TAG_LINE" | grep -oP '#[\w-]+')

    if [ -z "$INLINE_TAGS" ]; then
        if [ "$FILTER" = "all" ] || [ "$FILTER" = "skip" ]; then
            echo "‚ö†Ô∏è $FILE - No valid tags on line 3 manual check recommended"
        fi

        if [ "$DRY_RUN" = true ]; then
            echo "üß™ DRY RUN: Would log ‚Üí level=warn event=tag_skipped file=$(basename "$FILE") reason=no_tags_found"
        else
            echo "$(date +'%FT%T') level=warn event=tag_skipped file=$(basename "$FILE") reason=no_tags_found" >> "$LOG_FILE"
        fi
        continue
    fi

    # Convert #tags ‚Üí grafana, docker
    YAML_TAGS=$(echo "$INLINE_TAGS" | sed 's/#//g' | tr '\n' ',' | sed 's/,$//')

    # Build the new file content into a temp file
    TMP_FILE=$(mktemp)
    echo "---" >> "$TMP_FILE"
    echo "tags: $YAML_TAGS" >> "$TMP_FILE"
    echo "---" >> "$TMP_FILE"
    echo "" >> "$TMP_FILE"
    cat "$FILE" >> "$TMP_FILE"

    if [ "$DRY_RUN" = true ]; then
        echo "üß™ DRY RUN: Would inject into $FILE ‚Üí tags: $YAML_TAGS"
        rm "$TMP_FILE"
    else
        mv "$TMP_FILE" "$FILE"
        if [ "$FILTER" = "all" ] || [ "$FILTER" = "success" ]; then
            echo "‚úÖ Tags injected: $YAML_TAGS"
            echo "üìù $FILE updated with tags: $YAML_TAGS"
        fi

        echo "$(date +'%FT%T') level=info event=tag_injected file=$(basename "$FILE") tags=$YAML_TAGS" >> "$LOG_FILE"
        echo "Log entry added to $LOG_FILE"
fi

done
```

### üõ†Ô∏è Promptail not registering taglog.log

#### 1. Confirm Promtail couldn't see the file inside the container

```bash
docker exec -it promtail sh
ls /mnt/storage/logs/taglog.log  
```

‚ùå No such file

#### 2. Add a volume mount to docker-compose.yml (in promtail service)

```yaml
/mnt/storage/logs:/mnt/storage/logs
```

#### 3. Restart Promtail with updated volume mount

```bash
docker compose up -d promtail
```

#### 4. Confirm file is now visible inside the container

```bash
docker exec -it promtail sh
ls /mnt/storage/logs/taglog.log  # 
```

‚úÖ File is now visible

#### 5. Confirm Promtail started tailing the file

```bash
docker logs -f promtail  # Look for: "tail routine: started"
```

#### 6. Query logs in Grafana

```query
{job="taglog"}  #
```

‚úÖ Logs now appear!

## üîó Key Resources

- [Docker CLI Formatting](https://docs.docker.com/engine/cli/formatting/)
- [Docker CLI Reference](https://docs.docker.com/reference/cli/docker/)
- [Devhints](https://devhints.io/)
- [Grafana Promtail Documentation](https://grafana.com/docs/alloy/latest/set-up/migrate/from-promtail/)

---

## üóìÔ∏è Next Day Preview

- [] Tweak cAdvisor a bit, using too much resources
- [] Serve your own static site via Nginx
- [] Try volumes and bind mounts in Docker
- [] Automate backups with a script
- [] Possibly try watchtower or portainer if you're going wild
- [] Update the taglog.logs script to look for changes in the tags
- [] Migrate promtail to Grafana Alloy
